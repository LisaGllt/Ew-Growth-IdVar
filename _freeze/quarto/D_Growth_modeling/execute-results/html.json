{
  "hash": "66d7c4ca391740a4c9c65756d282d34c",
  "result": {
    "engine": "knitr",
    "markdown": "\n\n\n\n\n# Analysis of experimental data\n\nThe model is now fitted on our experimental data.\n\n## Data used\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\ndf_growth <- read_excel(here::here(\"data/Data_growth_EPX_DMX.xlsx\"), sheet=\"Growth\") # <1>\n\ndead <- subset(df_growth, t==14 & status == \"D\")$ID                                  # <2>\n\ndf_growth <- df_growth |> \n  subset(t<57 & (!ID %in% dead)) |>                                                  # <3>\n  mutate(\n    L            = w^(1/3),                                                          # <4>\n    exposition   = as.factor(0 + 1*(exposition == \"Trt\")),                           # <5>\n    ID           = as.factor(ID)\n    )\n\ndf_growth_mean <- df_growth |>                                                       # <6>\n  aggregate(w ~ t + exposition, mean)                                                # <6>\n\nn_ctrl <- length(subset(df_growth, t==0 & exposition == 0)$ID)                       # <7>\nn_trt <- length(subset(df_growth, t==0 & exposition == 1)$ID)                        # <7>\n```\n:::\n\n\n\n\n1.  Raw data importation\n2.  Individuals that died before day 56\n3.  Dataset of the first 56 days without the dead individuals\n4.  Structural length calculation (mg$^{1/3}$/d)\n5.  Creation of a new exposition variable for the sake of short model parameters' names\n6.  Creation of a dataset with the mean growth per exposition group\n7.  Number of individuals in each group\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha_point <- 0.5\nalpha_line <- 0.3\n\np_growth <- ggplot(\n  data=df_growth, \n  aes(\n    x=t, \n    y=w, \n    color=exposition, \n    group=ID\n    )\n  ) +\n  \n  geom_line(\n    lwd=0.8, \n    alpha=alpha_line, \n    color = \"grey80\"\n    ) +\n  geom_point(\n    alpha=alpha_point, \n    size=2\n    ) +\n  facet_wrap(~exposition) +\n  \n  scale_color_manual(\n    values = pal_col, \n    label  = c(\"Non exposed\", \"Exposed\"), \n    name   = \"\"\n    ) +\n  \n  labs(\n    x         = \"Time (days)\", \n    y         = \"Weight (mg)\",\n    title     = \"Growth monitoring\",\n    subtitle  = \"For the <span style = 'color:#5E81AC;'>non exposed</span> \n       and <span style = 'color:#f42404;'>exposed</span> groups\"\n    )+\n  \n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  theme_minimal(12)+\n  theme(\n    legend.position = \"none\",\n        \n    title=element_markdown(face=\"bold\"),\n    plot.subtitle=element_markdown(face=\"plain\"),\n        \n    axis.title=element_text(face=\"plain\"),\n        \n    strip.background = element_blank(),\n    strip.text = element_blank()\n    )\n\np_growth\n```\n\n::: {.cell-output-display}\n![Evolution of fresh body weight of non-exposed earthworms (blue points and thin lines, each line corresponding to one individual) and earthworms exposed to the equivalent of 3 RD of SwingÂ® Gold renewed each 28 days (red points and thin lines, each line corresponding to one individual).](D_Growth_modeling_files/figure-html/fig-growthdataset2-1.png){#fig-growthdataset2 width=576}\n:::\n:::\n\n\n\n\nComparison of the initial state in both cohorts :\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_growth_t0 <- subset(df_growth, t==0)  # <1>\n\n# Equality of variances\nvar.test(                                # <2>\n  subset(df_growth_t0, exposition==0)$w, # <2>\n  subset(df_growth_t0, exposition==1)$w  # <2>\n  )                                      # <2>\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tF test to compare two variances\n\ndata:  subset(df_growth_t0, exposition == 0)$w and subset(df_growth_t0, exposition == 1)$w\nF = 1.0131, num df = 26, denom df = 26, p-value = 0.9737\nalternative hypothesis: true ratio of variances is not equal to 1\n95 percent confidence interval:\n 0.4617116 2.2231315\nsample estimates:\nratio of variances \n          1.013136 \n```\n\n\n:::\n:::\n\n\n\n\n1.  Dataset for t=0.\n2.  Equality of weight variance test between the two groups.\n\nThe datasets are not inconsistent with a ratio of variances equal to 1.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Equality of means\nt.test(df_growth_t0$w~df_growth_t0$exposition, var.equal=T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tTwo Sample t-test\n\ndata:  df_growth_t0$w by df_growth_t0$exposition\nt = 0.41076, df = 52, p-value = 0.6829\nalternative hypothesis: true difference in means between group 0 and group 1 is not equal to 0\n95 percent confidence interval:\n -1.496523  2.266894\nsample estimates:\nmean in group 0 mean in group 1 \n       12.47778        12.09259 \n```\n\n\n:::\n:::\n\n\n\n\nWe can conclude there is no effect of the cohort on the initial weight of the individuals.\n\n## Model prior definition {#sec-modeldef}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\n# Model definition\nbf.mod.VI <- \n  \n  bf(\n    L  ~ L0+a*t,                            # <1> \n    L0 ~ 1 + (1||ID),                       # <2>\n    a  ~ 0 + exposition+(0+exposition||ID), # <3>\n    \n    center=T,                               # <4>\n    nl=T                                    # <5>\n  )                              \n```\n:::\n\n\n\n\n1.  Equation of L depending on t\n2.  Each individual can have its own L0 value but L0 does not depend on the exposition\n3.  Each individual can have its own a value and a depend on the exposition\n4.  Data are centered in the calculation process\n5.  Our parameters have non-linear definitions\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nList_parameters <- \n  \n  c(\n    \"b_L0_Intercept\",       # L0_mu\n    \"sd_ID__L0_Intercept\",  # L0_sd\n    \"b_a_exposition0\",      # a_ctrl_mu\n    \"b_a_exposition1\",      # a_trt_mu\n    \"sd_ID__a_exposition0\", # a_ctrl_sd\n    \"sd_ID__a_exposition1\", # a_trt_sd\n    \"sigma\"                 # Residuals variance\n  )\n```\n:::\n\n\n\n\nThe model parameters are named as follows by `brms` :\n\n-   $L0_{\\mu}$ : `b_L0_Intercept`\n-   $L0_{\\sigma}$ : `sd_ID__L0_Intercept`\n-   $a_{\\text{ctrl},\\mu}$ : `b_a_exposition0`\n-   $a_{\\text{trt},\\mu}$ : `b_a_exposition1`\n-   $a_{\\text{ctrl},\\sigma}$ : `sd_ID__a_exposition0`\n-   $a_{\\text{trt},\\sigma}$ : `sd_ID__a_exposition1`\n\n## Priors definition\n\nThe priors were defined according to the results of @bart_2020a considering the studied non-exposed individuals. The same priors are given to the two cohorts. A growth rate individual variation of 20% was given as a prior for the two cohort.\n\n!!!!!!!!!!! JUSTIF CHOIX PRIORS !!!!!!!!!!!!!!!!!!!!!!!!!!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\n# Priors definition\npriors <- \n  prior(normal(2.25, 0.45), class = b, nlpar = L0, lb = 0) +          # <1>\n  prior(normal(2.25*0.2, 2.25*0.2), class = sd, nlpar = L0)+          # <2> \n\n  prior(normal(0.075, 0.015), class=b, coef=exposition0, nlpar = a) + # <3>\n  prior(normal(0.075, 0.015), class=b, coef=exposition1, nlpar = a) + # <4>\n\n  prior(normal(0.075*0.2, 0.075*0.2), class=sd,                       # <5>\n        coef=exposition0, group=ID, nlpar = a)+                       # <5>\n  prior(normal(0.075*0.2, 0.075*0.2), class=sd,                       # <6>\n        coef=exposition1, group=ID, nlpar = a)+                       # <6>\n\n  prior(exponential(1), sigma)                                        # <7>\n```\n:::\n\n\n\n\n1.  Prior on $L0_{\\mu}$\n2.  Prior on $L0_{\\sigma}$\n3.  Prior on $a_{\\text{ctrl},\\mu}$\n4.  Prior on $a_{\\text{trt},\\mu}$\n5.  Prior on $a_{\\text{ctrl},\\sigma}$\n6.  Prior on $a_{\\text{trt},\\sigma}$\n7.  Prior on residuals\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_dens <- Nord_polar[1]\nalpha_dens <- 0.5\nsizetitle <- 18\n\npriors$nlpar <- factor(priors$nlpar, levels = c(\"L0\", \"a\")) \n\n\np1 <- priors %>% \n  parse_dist() %>% \n  filter(class == \"b\") %>% \n  ggplot(\n    aes(\n      xdist = .dist_obj, \n      y = format(.dist_obj),\n      color = coef,\n      fill = coef\n      )\n    ) +\n  stat_dist_halfeye(\n    alpha = alpha_dens\n  ) +\n  facet_wrap(\n    ~nlpar+coef, \n    scales = \"free\"\n    ) +\n  scale_color_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  scale_fill_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  ggtitle(\"Intercepts\") +\n  labs(\n    x = \"Value\",\n    y = \"Density\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face=\"bold\", size = sizetitle),\n    strip.text = element_text(face=\"plain\", size = sizetitle-2),\n        )\n\np2 <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sd\") %>% \n  ggplot(\n    aes(\n      xdist = .dist_obj, \n      y = format(.dist_obj),\n      color = coef,\n      fill = coef\n      )\n    ) +\n  stat_dist_halfeye(\n    alpha = alpha_dens\n  ) +\n  facet_wrap(\n    ~nlpar+coef, \n    scales = \"free\"\n    ) +\n  scale_color_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  scale_fill_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  ggtitle(\"Inter-individual variances\") +\n  labs(\n    x = \"Value\",\n    y = \"Density\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face=\"bold\", size = sizetitle),\n    strip.text = element_text(face=\"plain\", size = sizetitle-2),\n    )\n\np3 <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sigma\") %>% \n  ggplot(\n    aes(\n      xdist = .dist_obj, \n      y = format(.dist_obj),\n      color = coef,\n      fill = coef\n      )\n    ) +\n  stat_dist_halfeye(\n    alpha = alpha_dens\n  ) +\n  facet_wrap(\n    ~nlpar, \n    scales = \"free\"\n    ) +\n  scale_color_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  scale_fill_manual(values = c(Nord_polar[4], Nord_frost[4], col_red))+\n  ggtitle(\"Residual variance\") +\n  labs(\n    x = \"Value\",\n    y = \"Density\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face=\"bold\", size = sizetitle),\n    strip.text = element_text(face=\"plain\", size = sizetitle-2),\n    )\n\np <- p1 + p2 + p3 + \n  plot_layout(ncol = 1)&\n  theme(legend.position = \"none\")\np\n```\n\n::: {.cell-output-display}\n![Priors of our model.](D_Growth_modeling_files/figure-html/fig-priorplot-1.png){#fig-priorplot width=1152}\n:::\n:::\n\n\n\n\n\n\n## Prior predictive check\n\nIn bayesian modeling, we first perform a prior predictive check before fitting the model to our data. This allows us to check on the rationnality of the chosen priors.\n\nResults of the model with the sampling of priors :\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm.1.VI.prior <- \n  \n  brm(\n    data = df_growth,                   # <1>\n    bf.mod.VI,                          # <2>\n    backend = \"cmdstanr\",               # <3>\n    prior = priors,                     # <4>\n    sample_prior = \"only\",              # <5>\n    cores = 4,                          # <6>\n    seed = 42,                          # <7>\n    iter = 1000, warmup = 500,          # <8>\n    control = list(\n      adapt_delta = .95,                # <9>\n      max_treedepth = 12                # <9>\n      ), \n    file=here::here(\"mod/m_brms_VI_prior\")   # <10>\n  )\n\nprint(m.1.VI.prior)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Family: gaussian \n  Links: mu = identity; sigma = identity \nFormula: L ~ L0 + a * t \n         L0 ~ 1 + (1 || ID)\n         a ~ 0 + exposition + (0 + exposition || ID)\n   Data: df_growth (Number of observations: 264) \n  Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;\n         total post-warmup draws = 2000\n\nMultilevel Hyperparameters:\n~ID (Number of levels: 54) \n                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsd(L0_Intercept)      0.56      0.36     0.03     1.34 1.00     1206      769\nsd(a_exposition0)     0.02      0.01     0.00     0.05 1.00     1565      920\nsd(a_exposition1)     0.02      0.01     0.00     0.05 1.00     1310      606\n\nRegression Coefficients:\n              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nL0_Intercept      2.24      0.43     1.38     3.09 1.00     2704     1088\na_exposition0     0.07      0.02     0.04     0.11 1.00     3926     1360\na_exposition1     0.07      0.01     0.05     0.10 1.00     3690     1352\n\nFurther Distributional Parameters:\n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma     0.98      0.91     0.04     3.50 1.00     2233     1224\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n```\n\n\n:::\n:::\n\n\n\n\n1.  Data used\n2.  Model to be used\n3.  Type of backend for calculations\n4.  Priors to be used\n5.  Work only done with priors and not the data\n6.  Cores for calculations\n7.  Seed for reproducibility\n8.  A total of 1000 interations are done with 500 that are part of the warmup phase\n9.  Control parameters on the iterations\n10. Path where the model results are saved\n\nWe can then plot the predictions of this model and see if they represent at least the full range of our experimental data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred <- predicted_draws(m.1.VI.prior, newdata=df_growth) # <1> \n\ny_max <- 480\n\np_ctrl <- ggplot()+\n  \n  stat_lineribbon(\n    data = pred[pred$exposition == 0,], \n    aes(x = t, y = .prediction^3, group = exposition),\n    .width=c(.99,.95,.8,.5),\n    color=\"black\"\n    )+\n  geom_line(\n    data = df_growth[df_growth$exposition==0,],\n    aes(x = t, y = L^3, group=ID),\n    color = \"black\",\n    alpha = 0.4\n    )+\n  geom_point(\n    data = df_growth[df_growth$exposition==0,],\n    aes(x = t, y = L^3, group = ID),\n    color = \"black\",\n    alpha = 0.4\n    )+\n  \n  scale_fill_manual(values = rev(pal_blue))+\n  \n  labs(y=\"Weight (mg)\", x=\"Time (days)\")+\n  \n  ylim(0, y_max)+\n  \n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  theme_minimal()+\n  theme(legend.position = \"none\")\n\n\np_trt <- ggplot()+\n  \n  stat_lineribbon(\n    data = pred[pred$exposition==1,],\n    aes(x = t, y=.prediction^3, group=exposition),\n    .width=c(.99,.95,.8,.5),\n    color=\"black\"\n    )+\n  geom_point(\n    data = df_growth[df_growth$exposition==1,],\n    aes(x = t, y = L^3, group = ID),\n    color = \"black\",\n    alpha = 0.4\n    )+\n  geom_line(\n    data = df_growth[df_growth$exposition==1,],\n    aes(x = t, y = L^3, group = ID),\n    color = \"black\",\n    alpha = 0.4\n    )+\n  \n  scale_fill_manual(values = rev(pal_red))+\n  \n  labs(y=\"Weight (mg)\", x=\"Time (days)\")+\n  \n  ylim(0, y_max)+\n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  theme_minimal(14)+\n  theme(legend.position = \"none\")\n\nplot.prior_pred <- p_ctrl + p_trt + \n  plot_layout(ncol = 2, guides = \"collect\") & \n  theme(\n    legend.position = \"right\", \n    title=element_text(face=\"bold\"), \n    axis.title.x = element_text(face=\"plain\"),\n    axis.title.y = element_text(face=\"plain\")\n    )\n\nplot.prior_pred\n```\n\n::: {.cell-output-display}\n![Prior predictive check.](D_Growth_modeling_files/figure-html/fig-priorpredVI-1.png){#fig-priorpredVI width=768}\n:::\n:::\n\n\n\n\n1.  Predictions from the model\n\nThe @fig-priorpredVI shows the chosen priors are realistic.\n\n## Posterior predictive check\n\n### Model fit\n\nWe can now fit the model to our experimental data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nm.1.VI.post <- \n  \n  brm(\n    data = df_growth,                              # <1>\n    bf.mod.VI,                                     # <2>\n    backend = \"cmdstanr\",                          # <3>\n    prior = priors,                                # <4>\n    save_pars = save_pars(all = TRUE),             # <5>\n    sample_prior = \"yes\",                          # <6>\n    seed = 42,                                     # <7>\n    chains = 4, cores = 4,                         # <8>\n    iter = 6000, warmup = 1000,                    # <9>\n    control = list(adapt_delta = .95,              # <10>\n    max_treedepth = 12),                           # <10>\n    file=here::here(\"mod/m_brms_VI_post\")   # <11>\n  )\n\nprint(m.1.VI.post)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Family: gaussian \n  Links: mu = identity; sigma = identity \nFormula: L ~ L0 + a * t \n         L0 ~ 1 + (1 || ID)\n         a ~ 0 + exposition + (0 + exposition || ID)\n   Data: df_growth (Number of observations: 264) \n  Draws: 4 chains, each with iter = 6000; warmup = 1000; thin = 1;\n         total post-warmup draws = 20000\n\nMultilevel Hyperparameters:\n~ID (Number of levels: 54) \n                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsd(L0_Intercept)      0.22      0.05     0.13     0.31 1.00     7241     8267\nsd(a_exposition0)     0.01      0.00     0.01     0.01 1.00    10530    13942\nsd(a_exposition1)     0.03      0.00     0.02     0.04 1.00     8878    11663\n\nRegression Coefficients:\n              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nL0_Intercept      2.18      0.04     2.09     2.26 1.00    21119    16149\na_exposition0     0.08      0.00     0.08     0.09 1.00    17038    15632\na_exposition1     0.08      0.01     0.06     0.09 1.00     3377     6048\n\nFurther Distributional Parameters:\n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma     0.29      0.02     0.26     0.32 1.00    12652    14915\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n```\n\n\n:::\n:::\n\n\n\n\n1.  Data used\n2.  Model to be used\n3.  Type of backend for calculations\n4.  Priors to be used\n5.  We want all parameters to be saved\n6.  Work done with priors and the data\n7.  Number of chains and cores for calculations\n8.  Seed for reproducibility\n9.  A total of 6000 interations are done with 1000 that are part of the warmup phase\n10. Control parameters on the iterations\n11. Path where the model results are saved\n\n### Parameter estimation results\n\nChains recuperation and calculation of additional parameters :\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_chains <- ggs(m.1.VI.post, burnin = T) |>                    # <1>\n  filter(Parameter %in% List_parameters) |>                     # <1>\n  mutate(                                                       # <1>\n    Chain=as.factor(Chain),                                     # <1>\n    value=value                                                 # <1>\n    )                                                           # <1>\n                                             \ndf_chains_post <- df_chains |>                                  # <2>\n  filter(Iteration>1000)                                        # <2>\n\ndf_chains_median <- df_chains_post |>                           # <3>\n  aggregate(value ~ Parameter, median) |>                       # <3>\n  rename(median = value)                                        # <3>\n\nParam_a_mu <- c(\n  \"b_a_exposition0\", \n  \"b_a_exposition1\"\n  )\nParam_a_sd <- c(\n  \"sd_ID__a_exposition0\", \n  \"sd_ID__a_exposition1\"\n  )\nParam_ctrl <- c(\n  \"b_a_exposition0\", \n  \"sd_ID__a_exposition0\"\n  )\nParam_trt <- c(\n  \"b_a_exposition1\", \n  \"sd_ID__a_exposition1\"\n  )\nParam_t0 <- c(\n  \"b_L0_Intercept\",\n  \"sd_ID__L0_Intercept\", \n  \"Delta_a_mu\", \n  \"Delta_a_sd\",\n  \"sigma\"\n  )\n\ndf_chains_post_large <-                        # <4>\n  dcast(                                       # <4>\n    data = df_chains_post,                     # <4>\n    formula = Iteration + Chain ~ Parameter,   # <4>\n    value.var = 'value'                        # <4>\n  )                                            # <4>\n\ndf_chains_post_large <- df_chains_post_large |>                 # <4>\n  mutate(                                                       # <4>\n    Delta_a_mu = b_a_exposition1-b_a_exposition0,               # <4>\n    Ratio_a_mu = b_a_exposition1/b_a_exposition0,               # <4>\n    Delta_a_sd = sd_ID__a_exposition1-sd_ID__a_exposition0,     # <4>\n    Ratio_a_sd = sd_ID__a_exposition1/sd_ID__a_exposition0,     # <4>\n    LnRR = log(b_a_exposition1/b_a_exposition0),                 # <4>\n    LnCVR = log((sd_ID__a_exposition1/b_a_exposition1)/(sd_ID__a_exposition0/b_a_exposition0))                    # <4>\n  )\n\ndf_chains_post_long <- df_chains_post_large |>                  # <4>\n  melt(                                                         # <4>\n    id.vars=c(\"Iteration\", \"Chain\"),                            # <4>\n    measure.vars=colnames(df_chains_post_large)[-c(1,2)],       # <4>\n    variable.name=\"Parameter\",                                  # <4>\n    value.name=\"value\"                                          # <4>\n  )                                                             # <4>\n\n\ndf_chains_post_long <- df_chains_post_long |> \n  mutate(\n    exposition = case_when(\n      Parameter %in% Param_ctrl ~ \"Non exposed\",\n      Parameter %in% Param_trt ~ \"Exposed\",\n      Parameter %in% Param_t0 ~ \"General\")\n    )\n```\n:::\n\n\n\n\n1.  Extraction of each chain iterations values for each parameters\n2.  Only iterations after the warmup phase\n3.  Adding medians from each distribution\n4.  Calculation and addition of 2 columns: $\\Delta a_{\\mu} = a_{\\text{trt},\\mu} - a_{\\text{ctrl},\\mu}$ & $\\Delta a_{\\sigma} = a_{\\text{trt},\\sigma} - a_{\\text{ctrl},\\sigma}$\n\nThe results of the pesticides effect can be expressed with a response ratio (Ln(RR), @eq-LnRR) and a coefficient of variation ratio (Ln(CVi), @eq-LnCVi).\n\n$$\n\\text{Ln}(\\text{RR}) = \\text{Ln}\\left( \\frac{a_{ctrl,\\mu}}{a_{trt,\\mu}} \\right)\n$$ {#eq-LnRR}\n\n$$\n\\text{Ln}(\\text{CVi}) = \\text{Ln}\\left( \\frac{CV_{ctrl}}{CV_{trt}} \\right) - \\frac{1}{2(n_{trt}-1)}-\\frac{1}{2(n_{ctrl}-1)}\\\\\n$$ {#eq-LnCVi}\n\nWith :\n\n$$\nCV_{x}=\\frac{a_{x,\\sigma}}{a_{x,\\mu}}\n$$\n\nParameters estimation results :\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha_dens <- 0.5\nalpha_dens_prior <- 0.2\nfont_size <- 12\ncol_dens <- Nord_polar[1]\ncol_dens_ctrl <- Nord_frost[4]\ncol_dens_trt <- col_red\nsize_norm <- 0.7\n\nprior_L0_mu <- priors %>% \n  parse_dist() %>% \n  filter(class == \"b\" & nlpar == \"L0\")\nprior_L0_sd <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sd\" & nlpar == \"L0\")\n\nprior_a_ctrl_mu <- priors %>% \n  parse_dist() %>% \n  filter(class == \"b\" & nlpar == \"a\" & coef == \"exposition0\")\nprior_a_ctrl_sd <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sd\" & nlpar == \"a\" & coef == \"exposition0\")\n\nprior_a_trt_mu <- priors %>% \n  parse_dist() %>% \n  filter(class == \"b\" & nlpar == \"a\" & coef == \"exposition1\")\nprior_a_trt_sd <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sd\" & nlpar == \"a\" & coef == \"exposition1\")\n\nprior_sigma <- priors %>% \n  parse_dist() %>% \n  filter(class == \"sigma\")\n\nplot_L0_mu <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_L0_mu,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"b_L0_Intercept\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Mean initial structural length \" (mg^{1/3})))\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_L0_sd <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_L0_sd,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"sd_ID__L0_Intercept\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Individual variation of\\ninitial structural length \" (mg^{1/3})))\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_a_ctrl_mu <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_a_ctrl_mu,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"b_a_exposition0\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens_ctrl,\n    color = col_dens_ctrl,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Mean growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Non-exposed\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_a_trt_mu <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_a_trt_mu,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"b_a_exposition1\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens_trt,\n    color = col_dens_trt,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Mean growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Exposed\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_a_ctrl_sd <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_a_ctrl_sd,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"sd_ID__a_exposition0\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens_ctrl,\n    color = col_dens_ctrl,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Inter-individual variation\\nof growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Non-exposed\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_a_trt_sd <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_a_trt_sd,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"sd_ID__a_exposition1\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens_trt,\n    color = col_dens_trt,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Inter-individual variation\\nof growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Exposed\"\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\nplot_sigma <-\n  ggplot() +\n  stat_dist_halfeye(\n    data = prior_sigma,\n    aes(\n      xdist = .dist_obj\n      ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens_prior\n  ) +\n  stat_halfeye(\n    data = subset(df_chains_post_long,Parameter == \"sigma\"),\n    mapping = aes(\n      x=value,\n    ),\n    fill = col_dens,\n    color = col_dens,\n    alpha = alpha_dens\n  ) +\n  labs(\n    x = \"Value\",\n    y = \"Density\",\n    title = bquote(bold(\"Residual variance\" (mg^{1/3})))\n    )+\n  theme_minimal()+\n  theme(\n    axis.text.y = element_text(angle = 90),\n    plot.title = element_text(face = \"bold\")\n        )\n\n\np <- (plot_L0_mu+ plot_a_ctrl_mu + plot_a_trt_mu)/(plot_L0_sd + plot_a_ctrl_sd   + plot_a_trt_sd) / plot_sigma \np\n```\n\n::: {.cell-output-display}\n![Prior (light grey) and posterior distributions for each parameter.](D_Growth_modeling_files/figure-html/fig-priorpost-1.png){#fig-priorpost width=1152}\n:::\n:::\n\n\n\n\nThe fit on data gives information on model parameters as the posterior distributions are much more restrictive on parameter values than our priors.\n\n\n\n\n::: {#tbl-compvalposttheoVI .cell tbl-cap='Comparaison  of the different statistical values of the posterior distributions'}\n\n```{.r .cell-code}\ndf_res_VI <- summarise_draws(tidy_draws(m.1.VI.post))\n\ndf_res_VI_show <- df_res_VI[1:7,]\n\ndf_res_VI_show |> datatable(\n  options = list(\n    dom = 't',\n    columnDefs = list(\n      list(className = 'dt-left', targets = \"_all\")\n      )\n    ), \n  class=\"hover\"\n  ) |> \n  formatRound(columns = 2:length(df_res_VI_show), digits = 4)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-d21232549f6afc70a72b\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-d21232549f6afc70a72b\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],[\"b_L0_Intercept\",\"b_a_exposition0\",\"b_a_exposition1\",\"sd_ID__L0_Intercept\",\"sd_ID__a_exposition0\",\"sd_ID__a_exposition1\",\"sigma\"],[2.175393975,0.08280232392,0.07516799257499999,0.221066395935,0.0088845763055,0.02774486837,0.28864003915],[2.17537,0.08281579999999999,0.0752077,0.220558,0.008736629999999999,0.0273127,0.2880675],[0.04362627717479869,0.002053785301100139,0.005312095202567485,0.04637698155480553,0.001815388999281648,0.004158212896481629,0.01600895040569091],[0.04289161799999985,0.002024267909999991,0.005251369200000005,0.04452692579999998,0.001743070581000001,0.003998572199999997,0.01590755670000004],[2.1029285,0.07944338499999999,0.06632117999999999,0.1468963,0.0061577855,0.021713455,0.2634849],[2.2475305,0.08615639999999999,0.08382269499999999,0.2984805999999999,0.0120613,0.03516588,0.31607045],[0.9999924871484911,1.000103369768266,1.001590336677965,1.00046814453146,1.000332035158015,1.000523825003238,1.00010714639077],[21118.9488483548,17038.22916098417,3376.820027214503,7241.309960732898,10530.46106824092,8877.958834861229,12651.78422190358],[16148.60390381583,15632.23981738199,6048.122515774236,8267.259775711282,13942.03375029303,11662.53448125362,14914.73949394171]],\"container\":\"<table class=\\\"hover\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>variable<\\/th>\\n      <th>mean<\\/th>\\n      <th>median<\\/th>\\n      <th>sd<\\/th>\\n      <th>mad<\\/th>\\n      <th>q5<\\/th>\\n      <th>q95<\\/th>\\n      <th>rhat<\\/th>\\n      <th>ess_bulk<\\/th>\\n      <th>ess_tail<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"dom\":\"t\",\"columnDefs\":[{\"targets\":2,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":3,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":4,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":5,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":6,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":7,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":8,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":9,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"targets\":10,\"render\":\"function(data, type, row, meta) {\\n    return type !== 'display' ? data : DTWidget.formatRound(data, 4, 3, \\\",\\\", \\\".\\\", null);\\n  }\"},{\"className\":\"dt-left\",\"targets\":\"_all\"},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"variable\",\"targets\":1},{\"name\":\"mean\",\"targets\":2},{\"name\":\"median\",\"targets\":3},{\"name\":\"sd\",\"targets\":4},{\"name\":\"mad\",\"targets\":5},{\"name\":\"q5\",\"targets\":6},{\"name\":\"q95\",\"targets\":7},{\"name\":\"rhat\",\"targets\":8},{\"name\":\"ess_bulk\",\"targets\":9},{\"name\":\"ess_tail\",\"targets\":10}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[\"options.columnDefs.0.render\",\"options.columnDefs.1.render\",\"options.columnDefs.2.render\",\"options.columnDefs.3.render\",\"options.columnDefs.4.render\",\"options.columnDefs.5.render\",\"options.columnDefs.6.render\",\"options.columnDefs.7.render\",\"options.columnDefs.8.render\"],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nratio_effet_mu <- abs(round((df_res_VI_show$median[3]-df_res_VI_show$median[2])/df_res_VI_show$median[2],2)*100)\naugmentation_effet_sd <- round(df_res_VI_show$median[6]/df_res_VI_show$median[5],2)\n\nper_ind_var_ctrl <- round(df_res_VI_show$median[5]/df_res_VI_show$median[2]*100, 2)\nper_ind_var_trt <- round(df_res_VI_show$median[6]/df_res_VI_show$median[3]*100, 2)\n```\n:::\n\n\n\n\nThe model estimations show a **reduction of 9 % in the mean growth rate** but a **multiplication by 3.13 of the inter-individual variation of the growth rate**.\n\nThere are 10.55 % of growth individual variation in the non-exposed group and 36.32 % in the exposed group.\n\n\n\n\n::: {#tbl-lnRRCVI .cell tbl-cap='Effect size results'}\n\n```{.r .cell-code}\n# Calculation of the results for Ln(RR) and Ln(CVi)\n\nMedian_LnRR <- median(subset(df_chains_post_long, Parameter==\"LnRR\")$value)\nMedian_LnCVR <- median(subset(df_chains_post_long, Parameter==\"LnCVR\")$value)\nMedian_LnRR_print <- round(Median_LnRR, 2)\nMedian_LnCVR_print <- round(Median_LnCVR, 2)\n\nMedian_Ratio_a_mu <- median(subset(df_chains_post_long, Parameter==\"Ratio_a_mu\")$value)\nMedian_Ratio_a_sd <- median(subset(df_chains_post_long, Parameter==\"Ratio_a_sd\")$value)\n\nCI_Ratio_a_mu <- bayestestR::ci(subset(df_chains_post_long, Parameter==\"Ratio_a_mu\")$value, method = \"ETI\", ci = 0.90)\nCI_Ratio_a_mu_p <- paste(\"[\", round(CI_Ratio_a_mu$CI_low,2), \" ; \", round(CI_Ratio_a_mu$CI_high,2), \"]\", sep=\"\")\nCI_Ratio_a_sd <- bayestestR::ci(subset(df_chains_post_long, Parameter==\"Ratio_a_sd\")$value, method = \"ETI\", ci = 0.90)\nCI_Ratio_a_sd_p <- paste(\"[\", round(CI_Ratio_a_sd$CI_low,2), \" ; \", round(CI_Ratio_a_sd$CI_high,2), \"]\", sep=\"\")\n\nCI_LnRR <- bayestestR::ci(subset(df_chains_post_long, Parameter==\"LnRR\")$value, method = \"ETI\", ci = 0.90)\nCI_LnRR_p <- paste(\"[\", round(CI_LnRR$CI_low,2), \" ; \", round(CI_LnRR$CI_high,2), \"]\", sep=\"\")\n\nCI_LnCVR <- bayestestR::ci(subset(df_chains_post_long, Parameter==\"LnCVR\")$value, ci = 0.90)\nCI_LnCVR_p <- paste(\"[\", round(CI_LnCVR$CI_low,2), \" ; \", round(CI_LnCVR$CI_high,2), \"]\", sep=\"\")\n\npd_LnRR <- p_direction(subset(df_chains_post_long, Parameter==\"LnRR\")$value)\npd_LnCVR <- p_direction(subset(df_chains_post_long, Parameter==\"LnCVR\")$value)\n\npd_Ratio_a_mu <- p_direction(subset(df_chains_post_long, Parameter==\"Ratio_a_mu\")$value)\npd_Ratio_a_sd <- p_direction(subset(df_chains_post_long, Parameter==\"Ratio_a_sd\")$value)\n\ndf_res_Ln <- data.frame(\n  Variable = c(\"LnRR\", \"LnCVR\", \"Ratio a_mu\", \"Ratio a_sd\"),\n  Median = c(Median_LnRR, Median_LnCVR, Median_Ratio_a_mu, Median_Ratio_a_sd),\n  CI = c(CI_LnRR_p, CI_LnCVR_p, CI_Ratio_a_mu_p, CI_Ratio_a_sd_p),\n  pd = c(pd_LnRR$pd, pd_LnCVR$pd, pd_Ratio_a_mu$pd, pd_Ratio_a_sd$pd)\n) |> \n  mutate(\n    Median = round(Median, 3)\n  )\n\n# Results expressed as LnRR and LnCVR\ndf_res_Ln |> datatable(\n  options = list(\n    dom = 't',\n    autoWidth = TRUE,\n    columnDefs = list(\n      list(className = 'dt-left', targets = \"_all\")\n      )\n    ), \n  class=\"hover\"\n  ) \n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-ebff74900b569ae6c6a6\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-ebff74900b569ae6c6a6\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\"],[\"LnRR\",\"LnCVR\",\"Ratio a_mu\",\"Ratio a_sd\"],[-0.097,1.244,0.908,3.145],[\"[-0.23 ; 0.02]\",\"[0.82 ; 1.69]\",\"[0.8 ; 1.02]\",\"[2.1 ; 4.79]\"],[0.9116875,1,1,1]],\"container\":\"<table class=\\\"hover\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Variable<\\/th>\\n      <th>Median<\\/th>\\n      <th>CI<\\/th>\\n      <th>pd<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"dom\":\"t\",\"autoWidth\":true,\"columnDefs\":[{\"className\":\"dt-left\",\"targets\":\"_all\"},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"Variable\",\"targets\":1},{\"name\":\"Median\",\"targets\":2},{\"name\":\"CI\",\"targets\":3},{\"name\":\"pd\",\"targets\":4}],\"order\":[],\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n### Chains\n\nWe can check if the chains look good (@fig-chainsVI) and have a first look to the posterior distributions (@fig-postdistribVI).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <-  \n  ggplot(\n    data = df_chains_post, \n    aes(\n      x = Iteration, \n      y = value, \n      color = Chain, \n      group = Chain\n      )\n  )+\n  geom_line(alpha=0.7)+\n  facet_wrap(~Parameter, scales = \"free\", ncol = 2)+\n  \n  scale_color_manual(values = nord(palette = \"frost\"))+\n  \n  theme_bw()+\n  theme(\n    legend.position = \"right\", \n    title=element_text(size=12, face=\"plain\"), \n    axis.title.x = element_text(face=\"plain\"),\n    strip.background = element_rect(fill=\"white\")\n    )\n\nplot\n```\n\n::: {.cell-output-display}\n![Parameters chains (without the first 1000 iterations of warmup).](D_Growth_modeling_files/figure-html/fig-chainsVI-1.png){#fig-chainsVI width=768}\n:::\n:::\n\n\n\n\n\n\nWe can also check on the parameters correlations (@fig-pairsVI).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbayesplot::color_scheme_set(\"gray\")\np <- pairs(m.1.VI.post, regex=T)\np\n```\n\n::: {.cell-output-display}\n![Parameters correlations](D_Growth_modeling_files/figure-html/fig-pairsVI-1.png){#fig-pairsVI width=960}\n:::\n:::\n\n\n\n\n\n\n### Comparison of observed vs predicted data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred <- predicted_draws(m.1.VI.post, newdata=df_growth)\npost_i <- as.data.frame(posterior_summary(m.1.VI.post))\n\nID <- subset(df_growth, t==0)$ID\nexpo <- subset(df_growth, t==0)$exposition\n\ndf_estimates <- \n  data.frame(\n    ID                = ID,\n    exposition        = expo,\n    r_L0_i            = post_i$Estimate[8:(8+length(ID)-1)],\n    r_a_i_expo_0      = post_i$Estimate[(8+length(ID)):(8+length(ID)*2-1)],\n    r_a_i_expo_1      = post_i$Estimate[(8+length(ID)*2):(8+length(ID)*3-1)],\n    r_a_i_2.5_expo_0  = post_i$Q2.5[(8+length(ID)):(8+length(ID)*2-1)],\n    r_a_i_2.5_expo_1  = post_i$Q2.5[(8+length(ID)*2):(8+length(ID)*3-1)],\n    r_a_i_97.5_expo_0 = post_i$Q97.5[(8+length(ID)):(8+length(ID)*2-1)],\n    r_a_i_97.5_expo_1 = post_i$Q97.5[(8+length(ID)*2):(8+length(ID)*3-1)]\n    ) |> \n  mutate(\n    L0_i = post_i$Estimate[1]+r_L0_i,\n    a_i = case_when(\n      exposition == 0 ~ post_i$Estimate[2]+r_a_i_expo_0,\n      exposition == 1 ~ post_i$Estimate[3]+r_a_i_expo_1\n      ),\n    a_i_2.5 = case_when(\n      exposition==0 ~ post_i$Q2.5[2]+r_a_i_expo_0,\n      exposition==1 ~ post_i$Q2.5[3]+r_a_i_expo_1\n      ),\n    a_i_97.5 = case_when(\n      exposition==0 ~ post_i$Q97.5[2]+r_a_i_expo_0,\n      exposition==1 ~ post_i$Q97.5[3]+r_a_i_expo_1\n      )\n    ) |> \n  select(ID, exposition, L0_i, a_i, a_i_2.5, a_i_97.5)\n\ndf_pred_mean <- pred |> \n  aggregate(\n    .prediction ~ t + ID + exposition, \n    FUN=mean\n    )\n\ndf_pred_Q <- pred |> \n  aggregate(\n    .prediction ~ t + ID + exposition, \n    FUN='quantile', \n    probs=c(2.5, 97.5)/100\n    )\n\n\ndf_pred <- df_pred_mean |> \n  cbind(df_pred_Q$.prediction[,1]) |> \n  cbind(df_pred_Q$.prediction[,2]) |>\n  mutate(Expo=case_when(exposition==0 ~ \"Non exposed\",\n                        exposition==1 ~ \"Exposed\"))\n\ncolnames(df_pred) <- c(\"t\", \"ID\", \"exposition\", \n                       \"pred_L_mean\", \"pred_L_Q2.5\", \"pred_L_Q97.5\", \"Expo\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_growth_ordered <- df_growth |> arrange(t) |> arrange(ID)\n\ndf_data_pred_obs <- df_pred |>\n  mutate(\n    w_obs = df_growth_ordered$w,\n    ratio_predobs = pred_L_mean^3 / w_obs\n    )\n\nfact_1 <- 1.5\nfact_2 <- 2\n\nseq_line <- seq(1.1, 600, 0.1)\n\ndf_line <- data.frame(\n  x1  = seq_line,\n  y1  = seq_line*fact_1,\n  x_1 = seq_line,\n  y_1 = seq_line/fact_1,\n  x2  = seq_line,\n  y2  = seq_line*fact_2,\n  x_2 = seq_line,\n  y_2 = seq_line/fact_2\n  )\n\nplot_predobs_log <- ggplot()+ \n  \n  geom_line(\n    data=df_line, \n    mapping=aes(x=x1, y=y1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_1, y=y_1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x2, y=y2), \n    linetype=\"dotted\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_2, y=y_2), \n    linetype=\"dotted\"\n    )+\n  geom_abline(intercept=0, slope=1)+\n  geom_pointrange(\n    data = df_data_pred_obs, \n    aes(\n      x=w_obs,\n      y=pred_L_mean^3,\n      ymin=pred_L_Q2.5^3,\n      ymax=pred_L_Q97.5^3, \n      color=Expo\n      ), \n    alpha=0.5\n    )+\n  \n  scale_x_log10(limits=c(1.6, 700))+\n  scale_y_log10(limits=c(1.6, 700))+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  labs(\n    x=\"Observed weight (mg)\", \n    y=\"Predicted weight (mg)\"\n    )+\n  \n  theme_minimal(24)+\n  theme(legend.position = \"bottom\")\n\nplot_predobs_log\n```\n\n::: {.cell-output-display}\n![Results of the model fit on experimental data. Predicted values are represented with points with their respective credibility interval of 95%. Red points correspond to the predicted value for exposed individuals and blue points for the non exposed individuals. Dashed and dotted lines represent the 1.5-folds and 2-fold changes, respectively. The full line represents the identity line.](D_Growth_modeling_files/figure-html/fig-predobsw-1.png){#fig-predobsw width=1152}\n:::\n:::\n\n::: {#tbl-foldpred .cell tbl-cap='Percentage of points in the X-fold change area'}\n\n```{.r .cell-code}\n# Percentage of points in the X-fold change area\nf_fold <- function(fold){\n  res <- length(\n    subset(\n      df_data_pred_obs, \n      ratio_predobs < fold & ratio_predobs > -fold\n      )$w_obs\n    )/length(subset(df_data_pred_obs, !is.na(w_obs))$t)\n  return(res)\n}\n\ndf_fold <- data.frame(fold = c(1.1, 1.2, 1.25, 1.3, 1.5, 1.7, 2)) %>%\n  mutate(per = signif(mapply(f_fold, fold),2)*100)\n\ncolnames(df_fold) <- c(\"Fold\", \"Percentage of predictions within\")\n\ndf_fold |> datatable(options = list(dom = 't'), class=\"hover\")\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7bc9f1ec1cb08bee6c34\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7bc9f1ec1cb08bee6c34\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],[1.1,1.2,1.25,1.3,1.5,1.7,2],[66,83,89,94,98,100,100]],\"container\":\"<table class=\\\"hover\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Fold<\\/th>\\n      <th>Percentage of predictions within<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"dom\":\"t\",\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"Fold\",\"targets\":1},{\"name\":\"Percentage of predictions within\",\"targets\":2}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n::: panel-tabset\n## Non-exposed\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Non-exposed\n\nplot_predobs_log_ind_ctrl_save <- ggplot()+ \n  \n  geom_line(\n    data=df_line, \n    mapping=aes(x=x1, y=y1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_1, y=y_1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x2, y=y2), \n    linetype=\"dotted\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_2, y=y_2), \n    linetype=\"dotted\"\n    )+\n  \n  geom_abline(intercept=0, slope=1)+\n  \n  geom_pointrange(\n    data = subset(df_data_pred_obs, exposition == 0), \n    aes(\n      x=w_obs,\n      y=pred_L_mean^3,\n      ymin=pred_L_Q2.5^3,\n      ymax=pred_L_Q97.5^3, \n      color=Expo\n      ), \n    alpha=0.5\n    )+\n  \n  facet_wrap(~ID, ncol=4)+\n  \n  scale_x_log10(limits=c(1.6, 700))+\n  scale_y_log10(limits=c(1.6, 700))+\n  \n  scale_color_manual(values=pal_col, name=\"\")+\n  scale_fill_manual(values=pal_col, name=\"\")+\n  \n  labs(\n    x=\"Observed weight (mg)\", \n    y=\"Predicted weight (mg)\"\n    )+\n  \n  theme_minimal(20)+\n  theme(\n    legend.position = \"bottom\",\n    axis.text=element_text(size=10)\n    )\nplot_predobs_log_ind_ctrl_save\n```\n\n::: {.cell-output-display}\n![Results of the model fit on experimental data. Predicted values are represented with points with their respective credibility interval of 95%. Red points correspond to the predicted value for exposed individuals and blue points for the non exposed individuals. Dashed and dotted lines represent the 1.5-folds and 2-fold changes, respectively. The full line represents the identity line.](D_Growth_modeling_files/figure-html/fig-predobswindctrl-1.png){#fig-predobswindctrl width=960}\n:::\n:::\n\n\n\n\n## Exposed\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Exposed\n\nplot_predobs_log_ind_trt_save <- ggplot()+ \n  \n  geom_line(\n    data=df_line, \n    mapping=aes(x=x1, y=y1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_1, y=y_1), \n    linetype=\"dashed\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x2, y=y2), \n    linetype=\"dotted\"\n    )+\n  geom_line(\n    data=df_line, \n    mapping=aes(x=x_2, y=y_2), \n    linetype=\"dotted\"\n    )+\n  \n  geom_abline(intercept=0, slope=1)+\n  \n  geom_pointrange(\n    data = subset(df_data_pred_obs, exposition == 1), \n    aes(\n      x=w_obs,\n      y=pred_L_mean^3,\n      ymin=pred_L_Q2.5^3,\n      ymax=pred_L_Q97.5^3, \n      color=Expo\n      ), \n    alpha=0.5\n    )+\n  \n  facet_wrap(~ID, ncol=4)+\n  \n  scale_x_log10(limits=c(1.6, 700))+\n  scale_y_log10(limits=c(1.6, 700))+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  labs(\n    x=\"Observed weight (mg)\", \n    y=\"Predicted weight (mg)\"\n    )+\n  \n  theme_minimal(20)+\n  theme(\n    legend.position = \"bottom\",\n    axis.text=element_text(size=10)\n    )\nplot_predobs_log_ind_trt_save\n```\n\n::: {.cell-output-display}\n![Results of the model fit on experimental data. Predicted values are represented with points with their respective credibility interval of 95%. Red points correspond to the predicted value for exposed individuals and blue points for the non exposed individuals. Dashed and dotted lines represent the 1.5-folds and 2-fold changes, respectively. The full line represents the identity line.](D_Growth_modeling_files/figure-html/fig-predobswindtrt-1.png){#fig-predobswindtrt width=960}\n:::\n:::\n\n\n\n:::\n\n\n\n\n\n\n\n\n\n### Model predictions\n\nWe now check the predictions of the model at the population level (@fig-postpredVI) and the individual level (@fig-postpredVIindctrl & @fig-postpredVIindtrt) :\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_max <- 480\n\np_ctrl <- ggplot()+\n  \n  stat_lineribbon(\n    data = pred[pred$exposition == 0,],\n    aes(x=t, y=.prediction^3, group=exposition),\n    .width=c(.99,.95,.8,.5),\n    color=\"black\"\n    )+\n  geom_line(\n    data = df_growth[df_growth$exposition == 0,], \n    aes(x = t, y = L^3, group = ID), \n    color = \"#141c44\", \n    alpha = 0.4\n    )+\n  geom_point(\n    data = df_growth[df_growth$exposition == 0,], \n    aes(x = t, y = L^3, group = ID), color = \"#141c44\", alpha = 0.4\n    )+\n  \n  ylim(0, y_max)+\n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  scale_fill_manual(values = rev(pal_blue))+\n  \n  labs(y=\"Weight (mg)\", x=\"Time (days)\")+\n  \n  theme_minimal()+\n  theme(legend.position = \"none\")\n\np_trt <- ggplot()+\n  stat_lineribbon(\n    data = pred[pred$exposition == 1,], \n    aes(x=t, y = .prediction^3, group = exposition),\n    .width = c(.99,.95,.8,.5),\n    color = \"black\"\n    )+\n  geom_point(\n    data = df_growth[df_growth$exposition == 1,], \n    aes(x = t, y = L^3, group = ID), \n    color = \"#380000\", \n    alpha = 0.4\n    )+\n  geom_line(\n    data = df_growth[df_growth$exposition == 1,], \n    aes(x = t, y = L^3, group = ID), \n    color = \"#380000\", \n    alpha = 0.4\n    )+\n  \n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  ylim(0, y_max)+\n  \n  \n  scale_fill_manual(values = rev(pal_red))+\n  \n  labs(y = \"Weight (mg)\", x = \"Time (days)\")+\n  \n  theme_minimal()+\n  theme(legend.position = \"none\")\n\nplot.estimates.grp <- p_ctrl + p_trt + \n  plot_layout(ncol=2, guides=\"collect\") & \n  theme(\n    legend.position = \"right\", \n    title=element_text(face=\"bold\"), \n    axis.title.x = element_text(face=\"plain\"),\n    axis.title.y = element_text(face=\"plain\")\n    )\n\nplot.estimates.grp\n```\n\n::: {.cell-output-display}\n![Posterior predictive check. Fresh body weight of non-exposed earthworms (blue points and thin lines, each line corresponding to one individual) and earthworms exposed to the equivalent of 3 RD of SwingÂ® Gold renewed each 28 days (red points and thin lines, each line corresponding to one individual). Colored ribbons correspond to the different credibility intervals for the mean growth for each cohort. The thicker black lines represent the predicted mean body weight.](D_Growth_modeling_files/figure-html/fig-postpredVI-1.png){#fig-postpredVI width=768}\n:::\n:::\n\n\n\n\n\n\n::: panel-tabset\n## Non-exposed\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_ctrl <- ggplot()+\n  stat_lineribbon(\n    data = pred[pred$exposition==0,], \n    aes(x = t, y=.prediction^3, color=exposition, group=ID),\n    .width=c(.99,.95,.8,.5),\n    color=\"black\"\n    )+\n  geom_line(\n    data=df_growth[df_growth$exposition==0,], \n    aes(x=t, y=L^3, group=ID), \n    color=\"#141c44\", \n    alpha=0.25\n    )+\n  geom_point(\n    data=df_growth[df_growth$exposition==0,],\n    aes(x=t, y=L^3, group=ID), \n    color=\"#141c44\", \n    alpha=0.3, \n    size=2.5\n    )+\n  facet_wrap(~ID, ncol=5)+\n  \n  scale_fill_manual(values = rev(pal_blue))+\n  \n  labs(y=\"Weight (mg)\", x=\"Time (days)\")+\n  ylim(0, y_max)+\n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  theme_bw()+\n  theme(\n    legend.position = \"right\", \n    title=element_text(size=12, face=\"plain\"), \n    axis.title.x = element_text(face=\"plain\"),\n    strip.background = element_rect(fill=\"white\")\n    )\np_ctrl\n```\n\n::: {.cell-output-display}\n![Posterior predictive check. Fresh body weight of non-exposed earthworms (blue points) and earthworms exposed to the equivalent of 3 RD of SwingÂ® Gold renewed each 28 days (red points). Colored ribbons correspond to the different credibility intervals for the predicted growth for each individual. The thicker black lines represent the predicted body weight.](D_Growth_modeling_files/figure-html/fig-postpredVIindctrl-1.png){#fig-postpredVIindctrl width=864}\n:::\n:::\n\n\n\n\n## Exposed\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_trt <- ggplot()+\n  stat_lineribbon(\n    data = pred[pred$exposition==1,],\n    aes(x = t, y=.prediction^3, color=exposition, group=ID),\n    .width=c(.99,.95,.8,.5),\n    color=\"black\"\n    )+\n  geom_point(\n    data=df_growth[df_growth$exposition==1,], \n    aes(x=t, y=L^3, group=ID), \n    color=\"#380000\", \n    alpha=0.3, \n    size=2.5\n    )+\n  geom_line(\n    data=df_growth[df_growth$exposition==1,], \n    aes(x=t, y=L^3, group=ID), \n    color=\"#380000\", \n    alpha=0.25\n    )+\n  facet_wrap(~ID, ncol=5, nrow=6)+\n  \n  scale_fill_manual(values = rev(pal_red))+\n  \n  labs(y=\"Weight (mg)\", x=\"Time (days)\")+\n  ylim(0, y_max)+\n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  \n  theme_bw()+\n  theme(\n    legend.position = \"right\", \n    title=element_text(size=12, face=\"plain\"), \n    axis.title.x = element_text(face=\"plain\"),\n    strip.background = element_rect(fill=\"white\")\n    )\np_trt\n```\n\n::: {.cell-output-display}\n![Posterior predictive check. Fresh body weight of non-exposed earthworms (blue points) and earthworms exposed to the equivalent of 3 RD of SwingÂ® Gold renewed each 28 days (red points). Colored ribbons correspond to the different credibility intervals for the predicted growth for each individual. The thicker black lines represent the predicted body weight.](D_Growth_modeling_files/figure-html/fig-postpredVIindtrt-1.png){#fig-postpredVIindtrt width=864}\n:::\n:::\n\n\n\n:::\n\n\n\n\n\n\n\n\n\n## Individual parameters\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_L0_i <- ggplot(data=df_estimates, aes(x=L0_i))+\n  \n  stat_dotsinterval(subguide = 'integer')+\n  geom_dotplot(\n    alpha=0.5, \n    dotsize =0.5,\n    width = 0.7,\n    binwidth = 0.05\n    )+\n  ylim(ymin=0, ymax=0.20)+\n  \n  labs(\n    x = bquote(\"Estimated initial volumetric structural length \" (mg^{1/3})), \n    y=\"\", \n    title=\"L0_i\")+\n  \n  theme_ggdist()\n\nplot_a_i <- ggplot(\n  data=df_estimates, \n  aes(x=a_i, color=exposition, fill=exposition)\n  )+\n  \n  stat_dotsinterval(subguide = 'integer')+\n  geom_dotplot(\n    alpha=0.5, \n    dotsize =0.7,\n    width = 0.7,\n    binwidth = 0.005\n    )+\n  \n  facet_wrap(~exposition, ncol=1)+\n  \n  ylim(ymin=0, ymax=0.05)+\n  \n  labs(\n    x = bquote(\"Estimated growth rate \" (mg^{1/3}/d)), \n    y=\"\", \n    title=\"a_i\"\n    )+\n  \n  scale_color_manual(values=pal_col)+\n  scale_fill_manual(values=pal_col)+\n  \n  theme_ggdist()+\n  theme(\n    legend.position = \"bottom\",\n    strip.background = element_rect(fill=\"white\"),\n    strip.text=element_blank()\n    )\n\ngrid.arrange(\n  plot_L0_i, \n  plot_a_i, \n  layout_matrix = cbind(c(1, NA),c(2, 2)))\n```\n\n::: {.cell-output-display}\n![Distribution of the individual parameters values.](D_Growth_modeling_files/figure-html/fig-postestimatesind-1.png){#fig-postestimatesind width=960}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Normality tests for the distribution of parameters\nshapiro.test(df_estimates$L0_i)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  df_estimates$L0_i\nW = 0.98078, p-value = 0.5341\n```\n\n\n:::\n\n```{.r .cell-code}\nshapiro.test(subset(df_estimates, exposition==0)$a_i)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  subset(df_estimates, exposition == 0)$a_i\nW = 0.94225, p-value = 0.1385\n```\n\n\n:::\n\n```{.r .cell-code}\nshapiro.test(subset(df_estimates, exposition==1)$a_i)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  subset(df_estimates, exposition == 1)$a_i\nW = 0.79505, p-value = 0.0001125\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_diag <- Nord_polar[4]\n\nplot_QQ_L0 <- ggplot(mapping=aes(sample=df_estimates$L0_i))+\n  stat_qq(alpha=0.3,color=col_diag)+\n  stat_qq_line(color=col_diag)+\n  labs(x=\"Normal quantiles\", y=\"Residuals\", \n       title = bquote(bold(\"Initial structural length\")))+\n  theme_bw()\n\nplot_QQ_a_ctrl <- ggplot(\n  mapping=aes(\n    sample=subset(df_estimates, exposition==0)$a_i\n    )\n  )+\n  stat_qq(\n    alpha=0.3,\n    color=col_blue\n    )+\n  stat_qq_line(color=col_blue)+\n  labs(\n    x=\"Normal quantiles\", \n    y=\"Residuals\", \n    title=bquote(bold(\"Growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Non-exposed\"\n       )+\n  theme_bw()\n\nplot_QQ_a_trt <- ggplot(\n  mapping=aes(\n    sample=subset(df_estimates, exposition==1)$a_i\n    )\n  )+\n  stat_qq(\n    alpha=0.3, \n    color=col_red\n    )+\n  stat_qq_line(color=col_red)+\n  labs(\n    x=\"Normal quantiles\", \n    y=\"Residuals\", \n    title=bquote(bold(\"Growth rate \" (mg^{1/3}/d))),\n    subtitle = \"Exposed\"\n    )+\n  theme_bw()\n\nplot <- plot_QQ_L0 + plot_QQ_a_ctrl + plot_QQ_a_trt + plot_layout(ncol=3)\nplot\n```\n\n::: {.cell-output-display}\n![Normality test for parameters' distributions.](D_Growth_modeling_files/figure-html/fig-qqplotailoi-1.png){#fig-qqplotailoi width=768}\n:::\n:::\n\n\n\n\n\n\n## Results summary\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\n# Simulation of predicted trajectories\n\n# Times with weight measurements\nt_values <- seq(0, 56, 0.1)\n\n# Calculation of each earthworm weight at each time point\ndf_data_pred <- df_estimates |> \n  expand_grid(t = t_values) |>   \n  mutate(\n    L = L0_i + a_i * t\n    )\ndf_data_pred <- df_data_pred |> \n  mutate(\n    w = L^3,\n    exposition = case_when(\n      as.numeric(ID)<=30 ~ \"Non-exposed\",\n      as.numeric(ID)>30 ~ \"Exposed\")\n  )\n\ndf_data_pred$exposition <- factor(\n  df_data_pred$exposition, \n  levels = c(\"Non-exposed\", \"Exposed\")\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nline_width <- 1.2\ny_max <- 550\nx_max <- 57\nfont_size <- 16\n\nplot_growth_pred <- ggplot()+\n  ylim(ymin=0, ymax=y_max)+\n  xlim(xmin=0, xmax=x_max)+\n  geom_line(\n    data=df_data_pred, \n    aes(\n      x=t, \n      y=w, \n      group=ID, \n      color=exposition\n      ), \n    alpha=1\n    )+\n  scale_color_manual(values=pal_col)+\n  scale_fill_manual(values=pal_col)+\n  facet_wrap(~exposition)+\n  scale_x_continuous(\n    limits = c(0, 56),        \n    breaks = seq(0, 56, by = 28),        \n    minor_breaks = seq(0, 56, by = 14)\n  ) +\n  labs(\n    x=\"Time (days)\", \n    y=\"Weight (mg)\",\n    title = \"A\"\n    )+ \n  theme_minimal(font_size+4)+\n  theme(\n    legend.position = \"top\", \n    legend.title=element_blank(), \n    plot.title=element_text(size=sizetitle*1.5, face=\"bold\"), \n    axis.title.x = element_text(face=\"plain\", size=font_size+2), \n    axis.title.y = element_text(face=\"plain\", size=font_size+2),\n    strip.background = element_blank(),\n    strip.text = element_blank(),\n    plot.margin = margin(b = 40,\n                         t=10,\n                         l=10,\n                         r=10)\n    )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_delta <- Nord_polar[4]\nfont_size <- 16\nalpha_dens <- 0.6\nalpha_expo <- 0.4\n\nplot_res_mu <- ggplot(\n  data=subset(df_chains_post_long,Parameter %in% Param_a_mu), \n  aes(\n    #x=Parameter, \n    y=value,\n    color=exposition, \n    fill=exposition\n    )\n  )+\n  labs(\n    y=bquote(\"Mean growth rate \" (mg^{1/3}/d)),\n    title = \"B\"\n    )+\n  stat_halfeye(\n    adjust=0.5,\n    alpha=alpha_expo\n    )+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  theme_classic(font_size)+\n  theme(\n    plot.title=element_text(size=sizetitle*1.5, face=\"bold\"), \n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),\n    legend.position=\"none\",\n    plot.margin = margin(\n      b = 20,\n      t=20,\n      l=20,\n      r=20\n      )\n    )\n\nplot_res_sd <- ggplot(\n  data=subset(df_chains_post_long,Parameter %in% Param_a_sd), \n  aes(\n    #x=Parameter, \n    y=value, \n    color=exposition, \n    fill=exposition\n    )\n  )+\n  stat_halfeye(\n    adjust=0.5,\n    alpha=alpha_expo\n    )+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  labs(y=bquote(\n    \"Inter-idividual variation of growth rate \" (mg^{1/3}/d)\n    ),\n    title = \"C\"\n    )+\n  \n  theme_classic(font_size)+\n  theme(\n    plot.title=element_text(size=sizetitle*1.5, face=\"bold\"), \n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),\n    legend.position=\"none\",\n    plot.margin = margin(\n      b = 20,\n      t=20,\n      l=20,\n      r=20\n      )\n    )\n\nplot_res_mu_delta <- ggplot(\n  data=subset(df_chains_post_long,Parameter==\"Delta_a_mu\"), \n  aes(\n    #x=Parameter, \n    y=value\n    ), \n  color=col_delta, \n  fill=col_delta\n  )+\n  labs(y=\"Effect size\")+\n  stat_halfeye(\n    adjust=0.5, \n    alpha=alpha_expo\n    )+\n  geom_abline(\n    intercept=0, \n    slope=0, \n    color=col_delta, \n    linetype=\"dashed\"\n    )+\n  ylim(-0.025, 0.025)+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  theme_classic(font_size-2)+\n  theme(\n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),\n    legend.position=\"none\"\n    )\n\nplot_res_sd_delta <- ggplot(\n  data=subset(df_chains_post_long, Parameter==\"Delta_a_sd\"), \n  aes(\n    #x=Parameter, \n    y=value\n    ), \n  color=col_delta, \n  fill=col_delta\n  )+\n  labs(y=\"Effect size\")+\n  stat_halfeye(\n    adjust=0.5,\n    alpha=alpha_expo\n    )+\n  geom_abline(\n    intercept=0, \n    slope=0, \n    color=col_delta, \n    linetype=\"dashed\"\n    )+\n  ylim(-0.025, 0.025)+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  theme_classic(font_size-2)+\n  theme(\n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),\n    legend.position=\"none\"\n    )\n\nplot_res_mu_LnRR <- \n  ggplot(\n    data=subset(df_chains_post_long,Parameter==\"LnRR\"), \n    aes(\n      #x=Parameter, \n      y=value\n      ), \n    color=col_delta, \n    fill=col_delta\n    )+\n  \n  stat_halfeye(\n    adjust=0.5,\n    alpha=alpha_expo\n    )+\n  geom_abline(\n    intercept = 0, \n    slope = 0, \n    color = col_delta, \n    linetype = \"dashed\"\n    )+\n  annotate(\n    geom = \"text\", \n    x = 0.5, \n    y = 0.18, \n    label = paste(\"Median\\n =\", Median_LnRR_print),\n    size = 4.2\n    )+\n  \n  ylim(-0.25, 0.25)+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  labs(y=\"Effect size \\n(Ln RR)\")+\n  \n  theme_classic(font_size-3)+\n  theme(\n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),        \n    legend.position=\"none\"\n    )\n\nplot_res_sd_LnCVR <- \n  ggplot(\n    data=subset(df_chains_post_long, Parameter==\"LnCVR\"), \n    aes(\n      #x=Parameter, \n      y=value\n      ), \n    color=col_delta,\n    fill=col_delta\n    )+\n  \n  stat_halfeye(\n    adjust=0.5,\n    alpha=alpha_expo\n    )+\n  geom_abline(\n    intercept=0, \n    slope=0, \n    color=col_delta,\n    linetype=\"dashed\"\n    )+\n  annotate(\n    geom = \"text\", \n    x = 0.5, \n    y = -1.4, \n    label = paste(\"Median\\n =\", Median_LnCVR_print),\n    size = 4.2\n    )+\n  ylim(-2, 2)+\n  \n  scale_color_manual(values=rev(pal_col), name=\"\")+\n  scale_fill_manual(values=rev(pal_col), name=\"\")+\n  \n  labs(y=\"Effect size \\n(Ln CVi)\")+\n    \n  theme_classic(font_size-3)+\n  theme(\n    axis.line.x=element_blank(),\n    axis.title.x=element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.text.x=element_blank(),\n    legend.position=\"none\"\n    )\n\nplot <- plot_res_mu + plot_res_sd + \n  plot_res_mu_delta + plot_res_sd_delta + \n  plot_res_mu_LnRR + plot_res_sd_LnCVR +\n  plot_layout(ncol=2, guides=\"collect\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Results figure\nplot <- grid.arrange(\n  plot_growth_pred, \n  plot_res_mu, plot_res_sd,\n  plot_res_mu_LnRR, plot_res_sd_LnCVR,\n  ncol=6,\n    layout_matrix = cbind(\n    c(1, 1, 1, 2, 2, 2), \n    c(1, 1, 1, 2, 2, 2),\n    c(1, 1, 1, 2, 2, 2), \n    c(1, 1, 1, 2, 2, 2), \n    c(1, 1, 1, 2, 2, 2),\n    c(1, 1, 1, 4, NA, NA),\n    c(1, 1, 1, 4, NA, NA),\n    c(1, 1, 1, 3, 3, 3), \n    c(1, 1, 1, 3, 3, 3), \n    c(1, 1, 1, 3, 3, 3), \n    c(1, 1, 1, 3, 3, 3),\n    c(1, 1, 1, 3, 3, 3),\n    c(1, 1, 1, 5, NA, NA),\n    c(1, 1, 1, 5, NA, NA)\n    )\n  )\n\ngrid::grid.draw(plot)\n```\n\n::: {.cell-output-display}\n![Results summary. A) Estimated growth trajectories of non-exposed and exposed individuals (blue = non exposed, red = exposed). B) Comparison of the posterior distribution of the mean growth rate between the two cohorts and the corresponding effect size as the logarithm of the response ratio (Ln RR).  C) Comparison of the posterior distribution of the individual variation of growth rate between the two cohorts and the corresponding effect size as the logarithm of the coefficient of variation ratio (Ln CVi).](D_Growth_modeling_files/figure-html/fig-ressum-1.png){#fig-ressum width=1152}\n:::\n:::\n\n\n\n\n\n\n<button class=\"accordion-button\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseOne\">\n\n<b> Session Information </b>\n\n</button>\n\n:::: {#collapseOne .accordion-collapse .collapse}\n<div>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.2.2 (2022-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS 14.0\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRblas.0.dylib\nLAPACK: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\nattached base packages:\n [1] grid      parallel  stats4    stats     graphics  grDevices utils    \n [8] datasets  methods   base     \n\nother attached packages:\n [1] cmdstanr_0.8.0     rstan_2.32.6       StanHeaders_2.32.9 DT_0.33           \n [5] kableExtra_1.4.0   ggtext_0.1.2       nord_1.0.0         ggbreak_0.1.2     \n [9] reshape2_1.4.4     latex2exp_0.9.6    ggmcmc_1.5.1.1     brms_2.22.0       \n[13] Rcpp_1.0.12        plan_0.4-5         modelsummary_2.2.0 gridExtra_2.3     \n[17] ggpubr_0.6.0       lsmeans_2.30-0     emmeans_1.10.3     nlstools_2.1-0    \n[21] Hmisc_5.1-3        knitr_1.47         plotly_4.10.4      car_3.1-2         \n[25] carData_3.0-5      devtools_2.4.5     usethis_2.2.3      RColorBrewer_1.1-3\n[29] see_0.8.4.3        report_0.5.8       parameters_0.22.2  performance_0.12.0\n[33] modelbased_0.8.8   insight_0.20.4     effectsize_0.8.8   datawizard_0.11.0 \n[37] correlation_0.8.5  bayestestR_0.13.2  easystats_0.7.2    readxl_1.4.3      \n[41] fdrtool_1.2.17     tmvtnorm_1.6       gmm_1.8            sandwich_3.1-0    \n[45] Matrix_1.6-5       mvtnorm_1.2-5      deSolve_1.40       extrafont_0.19    \n[49] patchwork_1.2.0    ggdist_3.3.2       wesanderson_0.3.7  tidybayes_3.0.6   \n[53] viridis_0.6.5      viridisLite_0.4.2  ggthemes_5.1.0     here_1.0.1        \n[57] lubridate_1.9.3    forcats_1.0.0      stringr_1.5.1      dplyr_1.1.4       \n[61] purrr_1.0.2        readr_2.1.5        tidyr_1.3.1        tibble_3.2.1      \n[65] ggplot2_3.5.1      tidyverse_2.0.0   \n\nloaded via a namespace (and not attached):\n  [1] utf8_1.2.4           tidyselect_1.2.1     htmlwidgets_1.6.4   \n  [4] munsell_0.5.1        ragg_1.3.2           codetools_0.2-20    \n  [7] miniUI_0.1.1.1       withr_3.0.0          Brobdingnag_1.2-9   \n [10] colorspace_2.1-0     tables_0.9.28        rstudioapi_0.16.0   \n [13] ggsignif_0.6.4       Rttf2pt1_1.3.12      bayesplot_1.11.1    \n [16] labeling_0.4.3       farver_2.1.2         bridgesampling_1.1-2\n [19] rprojroot_2.0.4      coda_0.19-4.1        vctrs_0.6.5         \n [22] generics_0.1.3       TH.data_1.1-2        xfun_0.45           \n [25] timechange_0.3.0     markdown_1.13        R6_2.5.1            \n [28] cachem_1.1.0         gridGraphics_0.5-1   promises_1.3.0      \n [31] scales_1.3.0         multcomp_1.4-25      nnet_7.3-19         \n [34] gtable_0.3.5         processx_3.8.4       rlang_1.1.4         \n [37] systemfonts_1.1.0    splines_4.2.2        rstatix_0.7.2       \n [40] extrafontdb_1.0      lazyeval_0.2.2       inline_0.3.19       \n [43] broom_1.0.6          checkmate_2.3.1      yaml_2.3.8          \n [46] abind_1.4-5          crosstalk_1.2.1      backports_1.5.0     \n [49] httpuv_1.6.15        gridtext_0.1.5       tensorA_0.36.2.1    \n [52] tools_4.2.2          ggplotify_0.1.2      ellipsis_0.3.2      \n [55] jquerylib_0.1.4      posterior_1.6.0      sessioninfo_1.2.2   \n [58] plyr_1.8.9           base64enc_0.1-3      ps_1.7.6            \n [61] rpart_4.1.23         urlchecker_1.0.1     zoo_1.8-12          \n [64] cluster_2.1.6        fs_1.6.4             magrittr_2.0.3      \n [67] data.table_1.15.4    matrixStats_1.3.0    pkgload_1.4.0       \n [70] hms_1.1.3            mime_0.12            evaluate_0.24.0     \n [73] arrayhelpers_1.1-0   xtable_1.8-4         rstantools_2.4.0    \n [76] compiler_4.2.2       V8_4.4.2             htmltools_0.5.8.1   \n [79] ggfun_0.1.6          later_1.3.2          tzdb_0.4.0          \n [82] Formula_1.2-5        aplot_0.2.3          RcppParallel_5.1.7  \n [85] MASS_7.3-58.1        cli_3.6.3            pkgconfig_2.0.3     \n [88] foreign_0.8-87       xml2_1.3.6           svUnit_1.0.6        \n [91] svglite_2.1.3        bslib_0.7.0          QuickJSR_1.2.2      \n [94] ggstats_0.6.0        estimability_1.5.1   yulab.utils_0.1.7   \n [97] distributional_0.4.0 digest_0.6.36        rmarkdown_2.27      \n[100] cellranger_1.1.0     htmlTable_2.4.2      curl_5.2.1          \n[103] commonmark_1.9.1     shiny_1.8.1.1        lifecycle_1.0.4     \n[106] nlme_3.1-160         jsonlite_1.8.8       fansi_1.0.6         \n[109] pillar_1.9.0         lattice_0.22-6       loo_2.8.0           \n[112] GGally_2.2.1         fastmap_1.2.0        httr_1.4.7          \n[115] pkgbuild_1.4.4       survival_3.7-0       glue_1.7.0          \n[118] remotes_2.5.0        sass_0.4.9           stringi_1.8.4       \n[121] profvis_0.3.8        textshaping_0.4.0    memoise_2.0.1       \n```\n\n\n:::\n:::\n\n\n\n\n</div>\n::::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}